(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{124:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/2017_missing_viewdata_1-5f35bacb4307658f44600b58db7701b9.png"},125:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/2017_missing_viewdata_2-25225bd0ed2e5627c1161dafaaf8cabe.png"},75:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return c})),n.d(t,"toc",(function(){return l})),n.d(t,"default",(function(){return d}));var r=n(3),a=n(7),i=(n(0),n(82)),o={id:"workaround_missing_viewdata_sitecore_mvc",title:"A workaround for missing ViewData in Sitecore MVC"},c={unversionedId:"workaround_missing_viewdata_sitecore_mvc",id:"workaround_missing_viewdata_sitecore_mvc",isDocsHomePage:!1,title:"A workaround for missing ViewData in Sitecore MVC",description:"Passing data between Sitecore renderings can get tricky.",source:"@site/docs/2017_workaround_missing_viewdata_sitecore_mvc.md",slug:"/workaround_missing_viewdata_sitecore_mvc",permalink:"/workaround_missing_viewdata_sitecore_mvc",version:"current",sidebar:"someSidebar",previous:{title:"Chris Perks",permalink:"/"},next:{title:"Finding the current Action name from an MVC pipeline processor",permalink:"/finding_action_name_from_mvc_processor"}},l=[{value:"Pass data down, not across",id:"pass-data-down-not-across",children:[]},{value:"Let\u2019s recap on the main points here:",id:"lets-recap-on-the-main-points-here",children:[]}],s={toc:l};function d(e){var t=e.components,o=Object(a.a)(e,["components"]);return Object(i.b)("wrapper",Object(r.a)({},s,o,{components:t,mdxType:"MDXLayout"}),Object(i.b)("p",null,"Passing data between Sitecore renderings can get tricky."),Object(i.b)("p",null,"Sending messages between sibling renderings can lead us to worry about the order in which they render, and you may end up with renderings tightly coupled to other renderings. Jeremy Davis discusses ways to switch the order of rendering execution on his blog here: ",Object(i.b)("a",Object(r.a)({parentName:"p"},{href:"https://jermdavis.wordpress.com/2016/04/04/getting-mvc-components-to-communicate/"}),"https://jermdavis.wordpress.com/2016/04/04/getting-mvc-components-to-communicate/")),Object(i.b)("p",null,Object(i.b)("img",{alt:"img",src:n(124).default})),Object(i.b)("h3",{id:"pass-data-down-not-across"},"Pass data down, not across"),Object(i.b)("p",null,"My preferred approach is for renderings to be as isolated as possible and not need to talk to siblings. In a regular MVC site, we would instantiate a ",Object(i.b)("inlineCode",{parentName:"p"},"ViewModel"),", and pass it down to any child (or partial) views as needed. If a child view doesn\u2019t change this ",Object(i.b)("inlineCode",{parentName:"p"},"ViewModel")," at all, we don\u2019t have to worry about order of execution or changes of state."),Object(i.b)("p",null,"In Sitecore, we can achieve this by wrapping child renderings in a parent Controller Rendering. This Controller Rendering creates and prepares the ",Object(i.b)("inlineCode",{parentName:"p"},"ViewModel"),", and then passes it down to one or more child renderings."),Object(i.b)("p",null,Object(i.b)("img",{alt:"img",src:n(125).default})),Object(i.b)("h3",{id:"lets-recap-on-the-main-points-here"},"Let\u2019s recap on the main points here:"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"Our parent Controller Rendering creates and prepares a ",Object(i.b)("inlineCode",{parentName:"li"},"ViewModel"),". This parent specifies a view, which contains one or more placeholders."),Object(i.b)("li",{parentName:"ol"},"This ",Object(i.b)("inlineCode",{parentName:"li"},"ViewModel")," is passed along to any child renderings currently attached to the placeholders."),Object(i.b)("li",{parentName:"ol"},"During execution, child renderings do not modify the ",Object(i.b)("inlineCode",{parentName:"li"},"ViewModel"),". We may even consider the ",Object(i.b)("inlineCode",{parentName:"li"},"ViewModel")," immutable while rendering takes place.")),Object(i.b)("p",null,"Sitecore has a peculiarity here which makes our job difficult. Each rendering gets a new instance of ViewData \u2013 explained by Kern Herskind Nightingale here: ",Object(i.b)("a",Object(r.a)({parentName:"p"},{href:"http://stackoverflow.com/a/35210022/638064"}),"http://stackoverflow.com/a/35210022/638064"),". "),Object(i.b)("p",null,"This puts a stop to us using ",Object(i.b)("inlineCode",{parentName:"p"},"ViewData")," to pass our ",Object(i.b)("inlineCode",{parentName:"p"},"ViewModel")," down from the parent rendering to child renderings."),Object(i.b)("h4",{id:"the-workaround"},"The Workaround"),Object(i.b)("p",null,"There\u2019s a way you can ensure that ",Object(i.b)("inlineCode",{parentName:"p"},"ViewData")," is correctly passed down from parent to child renderings. Let\u2019s go through how this is possible."),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"In your top level controller, create a ",Object(i.b)("inlineCode",{parentName:"li"},"ViewModel"),", which will be passed down to all child renderings.")),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),'public ActionResult ParentContainer()\n{\n    var viewModel = new {PageSize = 3, CurrentPage = 2, Results = Sitecore.Context.Item.Fields["Results"].Value};\n    return View();\n}\n')),Object(i.b)("ol",{start:2},Object(i.b)("li",{parentName:"ol"},"Add it to the ",Object(i.b)("inlineCode",{parentName:"li"},"ViewData")," collection in the current ",Object(i.b)("inlineCode",{parentName:"li"},"ViewContext"))),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),'public ActionResult ParentContainer()\n{\n    var viewModel = new {PageSize = 3, CurrentPage = 2, Results = Sitecore.Context.Item.Fields["Results"].Value};\n    ContextService.Get().GetCurrent().ViewData.Add("_SharedModel", viewModel);\n    return View();\n}\n')),Object(i.b)("ol",{start:3},Object(i.b)("li",{parentName:"ol"},"In each child rendering, fetch the ",Object(i.b)("inlineCode",{parentName:"li"},"ViewModel")," and add it to the local ",Object(i.b)("inlineCode",{parentName:"li"},"ViewData")," for the current rendering (which will be empty at this point). View Renderings will do this step for you, so you don\u2019t need to do anything special there")),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"public ActionResult ChildRendering()\n{\n    // Get any ViewData previously added to this ViewContext\n    var contextViewData = ContextService.Get().GetCurrent().ViewData;\n    contextViewData.ToList().ForEach(x => ViewData.Add(x.Key, x.Value));\n    return View();\n}\n")),Object(i.b)("p",null,"Et voila! You now have access to the same ",Object(i.b)("inlineCode",{parentName:"p"},"ViewModel")," for each of your child renderings."),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),'@{\n    Layout = null;\n    var viewModel = ViewData["_SharedModel"];\n}\n')),Object(i.b)("h4",{id:"making-it-better"},"Making it better"),Object(i.b)("p",null,"MVC offers us even better tools to remove code duplication. If you have a lot of child renderings needing access to your shared ",Object(i.b)("inlineCode",{parentName:"p"},"ViewModel"),", adding the code in step 3 will happen a lot. Let\u2019s refactor that to an filter attribute."),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"public class RetrieveViewDataFilter : ActionFilterAttribute, IActionFilter\n{\n    public void OnActionExecuting(ActionExecutingContext filterContext)\n    {\n        //Merge ViewData from context\n        var contextViewData = ContextService.Get().GetCurrent().ViewData;\n        contextViewData.ToList().ForEach(x => filterContext.Controller.ViewData.Add(x.Key, x.Value));\n    }\n\n    public void OnActionExecuted(ActionExecutedContext filterContext)\n    {\n    }\n}\n")),Object(i.b)("p",null,"Now, we just need to add this attribute to any Action Methods who may want to access shared ",Object(i.b)("inlineCode",{parentName:"p"},"ViewData")," from higher up in the stack"),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"[RetrieveViewDataFilter]\npublic ActionResult ChildRendering()\n{\n    return View();\n}\n")),Object(i.b)("p",null,"There we go. I\u2019m sure Sitecore will amend their implementation at some point, but until then, we have an immutable, single direction ",Object(i.b)("inlineCode",{parentName:"p"},"ViewData")," flow."))}d.isMDXComponent=!0},82:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return m}));var r=n(0),a=n.n(r);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=a.a.createContext({}),d=function(e){var t=a.a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):c(c({},t),e)),n},p=function(e){var t=d(e.components);return a.a.createElement(s.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},u=a.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,o=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),p=d(n),u=r,m=p["".concat(o,".").concat(u)]||p[u]||b[u]||i;return n?a.a.createElement(m,c(c({ref:t},s),{},{components:n})):a.a.createElement(m,c({ref:t},s))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=u;var c={};for(var l in t)hasOwnProperty.call(t,l)&&(c[l]=t[l]);c.originalType=e,c.mdxType="string"==typeof e?e:r,o[1]=c;for(var s=2;s<i;s++)o[s]=n[s];return a.a.createElement.apply(null,o)}return a.a.createElement.apply(null,n)}u.displayName="MDXCreateElement"}}]);