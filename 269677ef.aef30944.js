(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{105:function(e,t,n){"use strict";n.d(t,"a",(function(){return b})),n.d(t,"b",(function(){return p}));var r=n(0),a=n.n(r);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=a.a.createContext({}),m=function(e){var t=a.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},b=function(e){var t=m(e.components);return a.a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},d=a.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),b=m(n),d=r,p=b["".concat(i,".").concat(d)]||b[d]||u[d]||o;return n?a.a.createElement(p,s(s({ref:t},l),{},{components:n})):a.a.createElement(p,s({ref:t},l))}));function p(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var l=2;l<o;l++)i[l]=n[l];return a.a.createElement.apply(null,i)}return a.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},80:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return s})),n.d(t,"toc",(function(){return c})),n.d(t,"default",(function(){return m}));var r=n(3),a=n(7),o=(n(0),n(105)),i={id:"load_sitecore_yaml_into_terraform",title:"Loading Sitecore 10 Kubernetes specifications from Terraform for turbocharged CI/CD"},s={unversionedId:"load_sitecore_yaml_into_terraform",id:"load_sitecore_yaml_into_terraform",isDocsHomePage:!1,title:"Loading Sitecore 10 Kubernetes specifications from Terraform for turbocharged CI/CD",description:"Feb 2021",source:"@site/docs/2021_load_sitecore_yaml_into_terraform.md",slug:"/load_sitecore_yaml_into_terraform",permalink:"/load_sitecore_yaml_into_terraform",version:"current",sidebar:"someSidebar",previous:{title:"Production Sitecore 10 AWS EKS deploys - connecting VPCs",permalink:"/sitecore_10_production_aws_deploys"},next:{title:"Deploy Sitecore 10 to Kubernetes with AWS EKS",permalink:"/sitecore_deploy_to_kubernetes_eks"}},c=[{value:"Introducing Terraform",id:"introducing-terraform",children:[]},{value:"Terraform and Sitecore Kubernetes",id:"terraform-and-sitecore-kubernetes",children:[]},{value:"Three ways to read the Sitecore Kubernetes manifests from your Terraform configurations",id:"three-ways-to-read-the-sitecore-kubernetes-manifests-from-your-terraform-configurations",children:[]},{value:"#1 - tfk8s",id:"1---tfk8s",children:[]},{value:"#2 - The kubectl Terraform provider",id:"2---the-kubectl-terraform-provider",children:[]},{value:"#3 - The kubectl Terraform provider with multiple files",id:"3---the-kubectl-terraform-provider-with-multiple-files",children:[]}],l={toc:c};function m(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(o.b)("wrapper",Object(r.a)({},l,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"Feb 2021")),Object(o.b)("p",null,"Since the advent of ",Object(o.b)("strong",{parentName:"p"},"Sitecore 10"),", more and more of us are shifting our deployments toward ",Object(o.b)("strong",{parentName:"p"},"Docker")," and ",Object(o.b)("strong",{parentName:"p"},"Kubernetes"),". Not only can running containers reduce costs, but we can now take advantage of a rich ecosystem of DevOps tools to automate the heavy lifting involved in deployments. "),Object(o.b)("div",{className:"admonition admonition-info alert alert--info"},Object(o.b)("div",Object(r.a)({parentName:"div"},{className:"admonition-heading"}),Object(o.b)("h5",{parentName:"div"},Object(o.b)("span",Object(r.a)({parentName:"h5"},{className:"admonition-icon"}),Object(o.b)("svg",Object(r.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(o.b)("path",Object(r.a)({parentName:"svg"},{fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"})))),"info")),Object(o.b)("div",Object(r.a)({parentName:"div"},{className:"admonition-content"}),Object(o.b)("p",{parentName:"div"},"In this blog post, we look at different ways to integrate Sitecore Kubernetes manifests and Terraform"))),Object(o.b)("h3",{id:"introducing-terraform"},"Introducing Terraform"),Object(o.b)("p",null,"Many organisations have embraced Infrastructure as Code (IAC) - tracking cloud (and less frequently, on-prem) infrastructure assets in version control and putting in place an automated, testable and auditable change workflow. "),Object(o.b)("p",null,Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://www.terraform.io/"}),"Terraform")," is the leading IAC tool which provides a description language for your infrastructure, and a powerful CLI to drive creation and management of your cloud services, networks, security policies, serverless functions and just about everything else. All of the main cloud vendors (Azure, AWS, Google Cloud) are supported, and engineers can create custom providers to ensure their service provider is covered. "),Object(o.b)("h3",{id:"terraform-and-sitecore-kubernetes"},"Terraform and Sitecore Kubernetes"),Object(o.b)("p",null,"Sitecore provides ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/Sitecore/container-deployment/releases"}),"official Kubernetes manifests")," - that is - descriptions of workloads to run within your cluster. These workloads correspond to the server roles you're familiar with - ",Object(o.b)("inlineCode",{parentName:"p"},"Content Delivery"),", ",Object(o.b)("inlineCode",{parentName:"p"},"Content Management"),", ",Object(o.b)("inlineCode",{parentName:"p"},"Solr"),", and so on. "),Object(o.b)("p",null,"Terraform can be used to deploy these workloads to your cluster - which is great if you're already invested in Terraform and have existing deployment pipelines you wish to extend to cover your Sitecore deployments. "),Object(o.b)("p",null,"Kubernetes manifests are in ",Object(o.b)("inlineCode",{parentName:"p"},".yaml")," format - but Terraform uses the ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://www.terraform.io/docs/language/syntax/configuration.html"}),"Hashicorp Configuration Language (HCL)")," - so, how can we get Terraform to read our Sitecore Kubernetes ",Object(o.b)("inlineCode",{parentName:"p"},".yaml")," files?"),Object(o.b)("h3",{id:"three-ways-to-read-the-sitecore-kubernetes-manifests-from-your-terraform-configurations"},"Three ways to read the Sitecore Kubernetes manifests from your Terraform configurations"),Object(o.b)("p",null,"Let's work with the ",Object(o.b)("inlineCode",{parentName:"p"},"cd.yaml")," manifest (",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/Sitecore/container-deployment/releases"}),"you can download this from Sitecore"),", along with manifests for other roles)"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-yaml",metastring:'title="sitecore-kubernetes-manifests/cd.yaml"',title:'"sitecore-kubernetes-manifests/cd.yaml"'}),"apiVersion: v1\nkind: Service\nmetadata:\n  name: cd\nspec:\n  selector:\n    app: cd\n  ports:\n  - protocol: TCP\n    port: 80\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: cd\n  labels:\n    app: cd\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: cd\n  template:\n    metadata:\n      labels:\n        app: cd\n    spec:\n      nodeSelector:\n        kubernetes.io/os: windows\n      containers:\n      - name: sitecore-xm1-cd\n        image: scr.sitecore.com/sxp/sitecore-xm1-cd:10.0-ltsc2019\n        ports:\n        - containerPort: 80\n        env:\n        - name: Sitecore_InstanceName\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n        - name: Database_Server\n          valueFrom:\n            secretKeyRef:\n              name: sitecore-database\n              key: sitecore-databaseservername.txt\n        - name: Core_Database_Username\n          valueFrom:\n            secretKeyRef:\n              name: sitecore-database\n              key: sitecore-core-database-username.txt\n        - name: Core_Database_Password\n          valueFrom:\n            secretKeyRef:\n              name: sitecore-database\n              key: sitecore-core-database-password.txt\n        - name: Web_Database_Username\n          valueFrom:\n            secretKeyRef:\n              name: sitecore-database\n              key: sitecore-web-database-username.txt\n        - name: Web_Database_Password\n          valueFrom:\n            secretKeyRef:\n              name: sitecore-database\n              key: sitecore-web-database-password.txt\n        - name: Forms_Database_Username\n          valueFrom:\n            secretKeyRef:\n              name: sitecore-database\n              key: sitecore-forms-database-username.txt\n        - name: Forms_Database_Password\n          valueFrom:\n            secretKeyRef:\n              name: sitecore-database\n              key: sitecore-forms-database-password.txt\n        - name: Sitecore_License\n          valueFrom:\n            secretKeyRef:\n              name: sitecore-license\n              key: sitecore-license.txt\n        - name: Sitecore_ConnectionStrings_Security\n          value: Data Source=$(Database_Server);Initial Catalog=Sitecore.Core;User ID=$(Core_Database_Username);Password=$(Core_Database_Password);\n        - name: Sitecore_ConnectionStrings_Web\n          value: Data Source=$(Database_Server);Initial Catalog=Sitecore.Web;User ID=$(Web_Database_Username);Password=$(Web_Database_Password);\n        - name: Sitecore_ConnectionStrings_ExperienceForms\n          value: Data Source=$(Database_Server);Initial Catalog=Sitecore.ExperienceForms;User ID=$(Forms_Database_Username);Password=$(Forms_Database_Password);\n        - name: Sitecore_ConnectionStrings_Solr.Search\n          valueFrom:\n            secretKeyRef:\n              name: sitecore-solr\n              key: sitecore-solr-connection-string.txt\n        - name: Sitecore_ConnectionStrings_Redis.Sessions\n          value: redis:6379,ssl=False,abortConnect=False\n        - name: SOLR_CORE_PREFIX_NAME\n          valueFrom:\n            secretKeyRef:\n              name: sitecore-solr\n              key: sitecore-solr-core-prefix-name.txt\n        livenessProbe:\n          httpGet:\n            path: /healthz/live\n            port: 80\n            httpHeaders:\n            - name: X-Kubernetes-Probe\n              value: Liveness\n          timeoutSeconds: 300\n          periodSeconds: 30\n          failureThreshold: 3\n        startupProbe:\n          httpGet:\n            path: /healthz/ready\n            port: 80\n            httpHeaders:\n            - name: X-Kubernetes-Probe\n              value: Startup\n          timeoutSeconds: 300\n          periodSeconds: 30\n          failureThreshold: 10\n      imagePullSecrets:\n      - name: sitecore-docker-registry\n")),Object(o.b)("h3",{id:"1---tfk8s"},"#1 - tfk8s"),Object(o.b)("p",null,Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/jrhouston/tfk8s"}),"tfk8s")," is a tool which converts Kubernetes ",Object(o.b)("inlineCode",{parentName:"p"},".yaml")," manifests into HCL, ready for use in Terraform. "),Object(o.b)("ol",null,Object(o.b)("li",{parentName:"ol"},"The tool is written in Go, so you will need to ",Object(o.b)("a",Object(r.a)({parentName:"li"},{href:"https://golang.org/dl/"}),"install Go")," first. "),Object(o.b)("li",{parentName:"ol"},"Clone ",Object(o.b)("inlineCode",{parentName:"li"},"https://github.com/jrhouston/tfk8s")," and run make install"),Object(o.b)("li",{parentName:"ol"},"Now, you can run the tool to get a deployable Terraform configuration: ")),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"tfk8s -f cd.yaml -o cd.tf\n")),Object(o.b)("h3",{id:"2---the-kubectl-terraform-provider"},"#2 - The kubectl Terraform provider"),Object(o.b)("p",null,"As we know from manually deploying Sitecore to Kubernetes, the ",Object(o.b)("inlineCode",{parentName:"p"},"kubectl")," tool is indispensable. Luckily, we can execute ",Object(o.b)("inlineCode",{parentName:"p"},"kubectl")," commands in our Terraform jobs by using the ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/gavinbunney/terraform-provider-kubectl"}),"Terraform kubectl provider"),". "),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-yaml",metastring:'title="sitecore-kubernetes-manifests/main.tf"',title:'"sitecore-kubernetes-manifests/main.tf"'}),'terraform {\n  required_providers {\n    kubectl = {\n      source  = "gavinbunney/kubectl"\n      version = ">= 1.7.0"\n    }\n  }\n}\nprovider "kubectl" {}\n')),Object(o.b)("p",null,"Once imported, you can embed manifest code directly in your Terraform configuration: "),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-yaml",metastring:'title="sitecore-kubernetes-manifests/main.tf"',title:'"sitecore-kubernetes-manifests/main.tf"'}),'resource "kubectl_manifest" "sitecore_cd" {\n    yaml_body = <<YAML\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: cd\n  labels:\n    app: cd\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: cd\n  template:\n    metadata:\n      labels:\n        app: cd\n    spec:\n      nodeSelector:\n        kubernetes.io/os: windows\n      containers:\n      - name: sitecore-xm1-cd\n        image: scr.sitecore.com/sxp/sitecore-xm1-cd:10.0-ltsc2019\n    ...\nYAML\n}\n')),Object(o.b)("h3",{id:"3---the-kubectl-terraform-provider-with-multiple-files"},"#3 - The kubectl Terraform provider with multiple files"),Object(o.b)("p",null,"The above approach of directly embedding your manifest in Terraform configuration is a bit clumsy and for even an ",Object(o.b)("inlineCode",{parentName:"p"},"XM1")," topology, we have 6+ separate manifest files. "),Object(o.b)("p",null,"To ensure our Terraform configuration stays lean and easy to manage, we can leave our manifest code as ",Object(o.b)("inlineCode",{parentName:"p"},".yaml")," files, and just reference those files from Terraform. "),Object(o.b)("p",null,"This approach is by far my favourite and feels cleanest. It again uses the excellent ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/gavinbunney/terraform-provider-kubectl"}),"Terraform kubectl provider"),". "),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-yaml",metastring:'title="sitecore-kubernetes-manifests/main.tf"',title:'"sitecore-kubernetes-manifests/main.tf"'}),'terraform {\n  required_providers {\n    kubectl = {\n      source  = "gavinbunney/kubectl"\n      version = ">= 1.7.0"\n    }\n  }\n}\nprovider "kubectl" {}\n')),Object(o.b)("p",null,"For the ",Object(o.b)("inlineCode",{parentName:"p"},"XM1")," external manifests, we use the following configuration: "),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-yaml",metastring:'title="sitecore-kubernetes-manifests/main.tf"',title:'"sitecore-kubernetes-manifests/main.tf"'}),'data "kubectl_path_documents" "external" {\n    pattern = "external/*.yaml"\n}\n\nresource "kubectl_manifest" "external" {\n    count     = length(data.kubectl_path_documents.external.documents)\n    yaml_body = element(data.kubectl_path_documents.external.documents, count.index)\n}\n')),Object(o.b)("p",null,"Here, ",Object(o.b)("inlineCode",{parentName:"p"},"kubectl_path_documents.external")," creates a list of files, looking in the external subdirectory for any ",Object(o.b)("inlineCode",{parentName:"p"},".yaml")," files. "),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"kubectl_manifest.external")," creates a manifest resource, by loading and merging all of the ",Object(o.b)("inlineCode",{parentName:"p"},".yaml")," files in the ",Object(o.b)("inlineCode",{parentName:"p"},"external/")," subdirectory. "),Object(o.b)("p",null,"We can follow the same approach for the other Sitecore manifests: "),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-yaml",metastring:'title="sitecore-kubernetes-manifests/main.tf"',title:'"sitecore-kubernetes-manifests/main.tf"'}),'data "kubectl_path_documents" "init" {\n    pattern = "init/*.yaml"\n}\n\nresource "kubectl_manifest" "init" {\n    count     = length(data.kubectl_path_documents.init.documents)\n    yaml_body = element(data.kubectl_path_documents.init.documents, count.index)\n}\n\ndata "kubectl_path_documents" "sitecore" {\n    pattern = "./*.yaml"\n}\n\nresource "kubectl_manifest" "sitecore" {\n    count     = length(data.kubectl_path_documents.sitecore.documents)\n    yaml_body = element(data.kubectl_path_documents.sitecore.documents, count.index)\n}\n\ndata "kubectl_path_documents" "ingress" {\n    pattern = "ingress-nginx/ingress.yaml"\n}\n\nresource "kubectl_manifest" "ingress" {\n    count     = length(data.kubectl_path_documents.ingress.documents)\n    yaml_body = element(data.kubectl_path_documents.ingress.documents, count.index)\n}\n')),Object(o.b)("p",null,"Have fun and let me know if you're working with Sitecore and Terraform. I'm on Sitecore Chat Slack!"))}m.isMDXComponent=!0}}]);