(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{142:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/2021_sitecore_eks_intro-0528de2f3c0cd19abb6f6b97f96c10f5.jpg"},143:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/2021_sitecore_eks_03-30f8213ae78835a8a24772e4ff32346a.jpeg"},144:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/2021_sitecore_eks_05-758d25b34a10f008e24fc7ba9955996e.jpeg"},145:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/2021_sitecore_eks_08-ed0b798c8038dde15944ced22d8f0368.jpeg"},146:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/2021_sitecore_eks_10-8e5c7650a1336bc47f9ca8be5be90154.jpeg"},147:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/2021_sitecore_eks_12-f8291d8780b1467848732d178c02b77b.jpeg"},148:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/2021_sitecore_eks_13-e6134368c58262f62207de57da65d1d4.jpeg"},149:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/2021_sitecore_eks_14-ac9e72235b1ef831129c2b04518ab2f9.jpeg"},150:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/2021_sitecore_eks_17-e09021a23df9aa0e871a272bb8e9ea6c.jpeg"},151:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/2021_sitecore_eks_19-547fa1d51d9a42d6edafb0e11ae96079.jpeg"},152:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/2021_sitecore_eks_20-c11aeeed41ef6717eedabff8bd1cde70.jpeg"},153:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/2021_sitecore_eks_21-105433043d2153b7a0dd331f3392938c.jpeg"},154:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/2021_sitecore_eks_23-110791e7b43a93881130f10e6d2047a4.jpeg"},155:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/2021_sitecore_eks_26-de5fac945ac0b8a50761b95bbf266f54.jpeg"},156:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/2021_sitecore_eks_34-750139358866c3e974964695dab10100.jpeg"},157:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/2021_sitecore_eks_37-b24b1ee455ac2f0b18803d416c88d7c0.jpeg"},158:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/2021_sitecore_eks_40-e1e49248645c98b37f9012a1c2c17037.jpeg"},159:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/2021_sitecore_eks_41-0bfe4451e90437c13f313cd13f735acf.jpeg"},160:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/2021_sitecore_eks_43-04ffc0508fe1d08e5d16a5f03a2c0664.jpg"},161:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/2021_sitecore_eks_42-2e33145de113ab6739364dd4d984a29e.jpeg"},75:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return s})),n.d(t,"metadata",(function(){return i})),n.d(t,"toc",(function(){return c})),n.d(t,"default",(function(){return b}));var o=n(3),a=n(7),r=(n(0),n(99)),s={id:"sitecore_deploy_to_kubernetes_eks",title:"Deploy Sitecore 10 to Kubernetes with AWS EKS"},i={unversionedId:"sitecore_deploy_to_kubernetes_eks",id:"sitecore_deploy_to_kubernetes_eks",isDocsHomePage:!1,title:"Deploy Sitecore 10 to Kubernetes with AWS EKS",description:"Feb 2021",source:"@site/docs/2021_sitecore_deploy_to_eks.md",slug:"/sitecore_deploy_to_kubernetes_eks",permalink:"/sitecore_deploy_to_kubernetes_eks",version:"current",sidebar:"someSidebar",previous:{title:"Chris Perks",permalink:"/"},next:{title:"Sustainable Sitecore - reducing CO2 emissions in your Sitecore stack",permalink:"/sitecore_sustainability_benefits"}},c=[{value:"Introducing Docker and Kubernetes",id:"introducing-docker-and-kubernetes",children:[]},{value:"But which Kubernetes?",id:"but-which-kubernetes",children:[]},{value:"In this guide",id:"in-this-guide",children:[]},{value:"Machine setup",id:"machine-setup",children:[]},{value:"Create and test the cluster",id:"create-and-test-the-cluster",children:[]},{value:"Adding the Windows node",id:"adding-the-windows-node",children:[]},{value:"Configure the deployment",id:"configure-the-deployment",children:[]},{value:"Deploy!",id:"deploy",children:[]},{value:"Test the deployment",id:"test-the-deployment",children:[]},{value:"Destroy all the things",id:"destroy-all-the-things",children:[]},{value:"Troubleshooting",id:"troubleshooting",children:[]},{value:"Conclusion",id:"conclusion",children:[]}],l={toc:c};function b(e){var t=e.components,s=Object(a.a)(e,["components"]);return Object(r.b)("wrapper",Object(o.a)({},l,s,{components:t,mdxType:"MDXLayout"}),Object(r.b)("p",null,Object(r.b)("inlineCode",{parentName:"p"},"Feb 2021")),Object(r.b)("p",null,"Sitecore 10 (",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"https://doc.sitecore.com/blog/sitecore-100-released.html"}),"released in August 2020"),") introduced ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"https://doc.sitecore.com/developers/100/developer-tools/en/containers-in-sitecore-development.html"}),"Sitecore Containers")," \u2013 a modern way of running Sitecore both on a developer machine, and in a production environment. "),Object(r.b)("div",{className:"admonition admonition-info alert alert--info"},Object(r.b)("div",Object(o.a)({parentName:"div"},{className:"admonition-heading"}),Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",Object(o.a)({parentName:"h5"},{className:"admonition-icon"}),Object(r.b)("svg",Object(o.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(r.b)("path",Object(o.a)({parentName:"svg"},{fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"})))),"info")),Object(r.b)("div",Object(o.a)({parentName:"div"},{className:"admonition-content"}),Object(r.b)("p",{parentName:"div"},"In this blog post, we create a new Kubernetes cluster and deploy Sitecore 10 in XM1 formation"))),Object(r.b)("p",null,Object(r.b)("img",{alt:"img",src:n(142).default})),Object(r.b)("h3",{id:"introducing-docker-and-kubernetes"},"Introducing Docker and Kubernetes"),Object(r.b)("p",null,"Using Docker, local development environments can be launched with minimal fuss and complete isolation from each other \u2013 enabling side-by-side installs of different Sitecore, Solr and MSSQL versions without any risk of cross-contamination. "),Object(r.b)("p",null,"In production, we can use Kubernetes to manage the deployment and runtime of our Docker containers, opening up a rich new CI/CD toolset to Sitecore developers, and giving opportunities to run less host servers, reducing operating cost and using less energy. "),Object(r.b)("h3",{id:"but-which-kubernetes"},"But which Kubernetes?"),Object(r.b)("p",null,"Sitecore provide ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"https://github.com/Sitecore/container-deployment/releases"}),"official documentation and scripts")," for deploying Sitecore XP into a managed Kubernetes environment on Azure, the Azure Kubernetes Service (AKS). Unless you have very specific requirements (or just want the fun of running Kubernetes DIY), managed Kubernetes is a great option. You\u2019ll save money, time and headaches by letting the cloud providers do what they do best, and manage all of the infrastructure and plumbing. "),Object(r.b)("p",null,"Most organisations already have one (or more) chosen cloud provider. Often a cloud provider is just chosen based on the existing skillset of staff, an engineering preference or just by pure accident. Luckily, the official Sitecore Kubernetes deployment guided can be easily adapted to target non-Azure cloud providers. "),Object(r.b)("h3",{id:"in-this-guide"},"In this guide"),Object(r.b)("p",null,"We\u2019ll be taking you through a journey to deploy a new Sitecore 10 instance into Kubernetes using ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"https://aws.amazon.com/eks/"}),"AWS\u2019 Elastic Kubernetes Service (EKS)"),". This is AWS\u2019 equivalent of Azure Kubernetes Service (AKS) and the good news is, the effort required to deploy to EKS is not much more than AKS. A few installation steps required tweaking, and we run into a few issues along the way. But if you\u2019re an AWS user, fear not. It\u2019s possible!"),Object(r.b)("h3",{id:"machine-setup"},"Machine setup"),Object(r.b)("p",null,"In the modern world of DevOps and GitOps, we should always prefer scriptable operations. I\u2019ve always found the AWS web console expansive, so getting to grips with a few well designed command-line tools can make the experience a lot smoother and allows you to turn your experiments into fully functioning CI/CD pipelines at a later date.\nI completed the following steps on a ",Object(r.b)("inlineCode",{parentName:"p"},"Windows 10 Pro")," machine with ",Object(r.b)("inlineCode",{parentName:"p"},"Powershell 5.1.18362.1171"),"\nHere is a list of the tooling we\u2019ll be installing: "),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("strong",{parentName:"li"},"Chocolatey")," \u2013 the package manager for Windows"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("strong",{parentName:"li"},"AWS CLI")," \u2013 access your AWS account from the command line"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("strong",{parentName:"li"},"kubectl")," \u2013 the command line tool to manage Kubernetes"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("strong",{parentName:"li"},"eksctl")," \u2013 an excellent command line to accelerate the creation and management of Kubernetes clusters "),Object(r.b)("li",{parentName:"ul"},Object(r.b)("strong",{parentName:"li"},"helm")," \u2013 the package manager for Kubernetes")),Object(r.b)("h5",{id:"1-open-a-powershell-session-as-administrator-and-install-chocolatey"},"1. Open a Powershell session as Administrator, and install Chocolatey"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))\n")),Object(r.b)("h5",{id:"2-install-the-aws-cli"},"2. Install the AWS CLI"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"choco install awscli\n")),Object(r.b)("h5",{id:"3-add-your-aws-credentials-to-the-current-powershell-session"},"3. Add your AWS credentials to the current Powershell session"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),'$Env:AWS_ACCESS_KEY_ID="*********************"\n$Env:AWS_SECRET_ACCESS_KEY="*********************"\n$Env:AWS_DEFAULT_REGION="eu-north-1"\n')),Object(r.b)("p",null,"These will be your own credentials, you can get them from the AWS Console. Note that you should set your preferred region \u2013 here I\u2019m using Stockholm. "),Object(r.b)("h5",{id:"4-test-to-make-sure-the-aws-cli-can-connect-to-your-account"},"4. Test to make sure the AWS CLI can connect to your account"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"aws s3 ls \n")),Object(r.b)("p",null,Object(r.b)("img",{alt:"img",src:n(143).default})),Object(r.b)("p",null,"You might not have any buckets here \u2013 that\u2019s okay. But if you get an authentication error, your credentials are incorrect. Fix that before moving on. "),Object(r.b)("h5",{id:"5-install-the-eksctl-tool"},"5. Install the eksctl tool"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"choco install eksctl \n")),Object(r.b)("p",null,Object(r.b)("img",{alt:"img",src:n(144).default})),Object(r.b)("h5",{id:"6-install-the-kubectl-tool"},"6. Install the kubectl tool"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"choco install kubernetes-cli\n")),Object(r.b)("h5",{id:"7-check-that-eksctl-is-ready-to-go-look-for-the-region-youre-using-to-make-sure-that-is-correct"},"7. Check that eksctl is ready to go! Look for the region you\u2019re using, to make sure that is correct."),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"eksctl get cluster\n")),Object(r.b)("p",null,Object(r.b)("img",{alt:"img",src:n(145).default})),Object(r.b)("h5",{id:"8-install-helm"},"8. Install Helm"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"choco install kubernetes-helm\n")),Object(r.b)("h3",{id:"create-and-test-the-cluster"},"Create and test the cluster"),Object(r.b)("h5",{id:"9-create-the-cluster"},"9. Create the cluster"),Object(r.b)("p",null,"Now we can begin the action! Creating a Kubernetes cluster sounds complicated at first, but eksctl does a great job of managing the underlying components and gives you a very simple API to work with: "),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"eksctl create cluster \u2013name sitecore-10-cluster \n")),Object(r.b)("div",{className:"admonition admonition-tip alert alert--success"},Object(r.b)("div",Object(o.a)({parentName:"div"},{className:"admonition-heading"}),Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",Object(o.a)({parentName:"h5"},{className:"admonition-icon"}),Object(r.b)("svg",Object(o.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"}),Object(r.b)("path",Object(o.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"})))),"tip")),Object(r.b)("div",Object(o.a)({parentName:"div"},{className:"admonition-content"}),Object(r.b)("p",{parentName:"div"},"This took around 15 minutes for me. Grab a tea!"))),Object(r.b)("p",null,Object(r.b)("img",{alt:"img",src:n(146).default})),Object(r.b)("p",null,"Notice that we\u2019re not providing much configuration here. That\u2019s perfectly fine, as eksctl will give us a new cluster with a Linux node by default. This is required on EKS. Even though our eventual Sitecore containers will run on a Windows host node, the required control plane components for EKS need to run on a Linux host. "),Object(r.b)("h5",{id:"10-test-that-the-cluster-is-up-and-running"},"10. Test that the cluster is up and running"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"kubectl get svc\n")),Object(r.b)("p",null,Object(r.b)("img",{alt:"img",src:n(147).default})),Object(r.b)("h5",{id:"11-we-now-need-to-modify-the-cluster-in-preparation-for-launching-a-windows-node-this-requires-an-extra-networking-component-that-our-default-cluster-creation-didnt-provide-again-eksctl-handles-most-of-the-work"},"11.\tWe now need to modify the cluster in preparation for launching a Windows node. This requires an extra networking component that our default cluster creation didn\u2019t provide. Again, eksctl handles most of the work:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"eksctl utils install-vpc-controllers \u2013cluster sitecore-10-cluster \u2013approve\n")),Object(r.b)("p",null,Object(r.b)("img",{alt:"img",src:n(148).default})),Object(r.b)("h5",{id:"12-lets-take-a-quick-break-to-peek-inside-the-aws-console-and-see-how-things-look-there-if-all-is-happy-youll-see-the-following"},"12. Let\u2019s take a quick break to peek inside the AWS Console and see how things look there. If all is happy, you\u2019ll see the following:"),Object(r.b)("p",null,Object(r.b)("img",{alt:"img",src:n(149).default})),Object(r.b)("p",null,"We have three Kubernetes control workloads (",Object(r.b)("inlineCode",{parentName:"p"},"coredns"),", ",Object(r.b)("inlineCode",{parentName:"p"},"aws-node")," and ",Object(r.b)("inlineCode",{parentName:"p"},"kube-proxy"),") along with the two VPC workloads we just created to support our Windows node: ",Object(r.b)("inlineCode",{parentName:"p"},"vpc-resource-controller")," and ",Object(r.b)("inlineCode",{parentName:"p"},"vpc-admission-webhook"),". "),Object(r.b)("h3",{id:"adding-the-windows-node"},"Adding the Windows node"),Object(r.b)("h5",{id:"13-as-sitecore-runs-inside-windows-docker-containers-we-need-a-windows-node-to-host-those-containers"},"13.\tAs Sitecore runs inside Windows Docker containers, we need a Windows node to host those containers."),Object(r.b)("p",null,"This is one of the big differences between containers and classic virtual machines \u2013 containers share most of the OS stack with the underlying host \u2013 so (for now), Windows containers require a Windows host. "),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"eksctl create nodegroup --cluster sitecore-10-cluster --name ng-windows --node-type t2.large --nodes 1 --nodes-min 1 --nodes-max 1 --node-ami-family WindowsServer2019FullContainer --region eu-north-1\n")),Object(r.b)("p",null,"At this point, I waited and waited, but the node never reached the ",Object(r.b)("inlineCode",{parentName:"p"},"Ready")," state. I had no idea what the issue was \u2013 but got the opportunity to learn some Kubernetes troubleshooting tools! See the Troubleshooting section at the end of this article. "),Object(r.b)("p",null,"After some research, I discovered that the ",Object(r.b)("inlineCode",{parentName:"p"},"t2.large")," node type is not supported for the type of Windows deployment I was attempting. I changed this to ",Object(r.b)("inlineCode",{parentName:"p"},"t3.large")," and after more waiting, the node finally came online. "),Object(r.b)("p",null,Object(r.b)("img",{alt:"img",src:n(150).default})),Object(r.b)("h3",{id:"configure-the-deployment"},"Configure the deployment"),Object(r.b)("p",null,"Our cluster is now up and running, with a Windows node ready for us to deploy Sitecore to. "),Object(r.b)("p",null,Object(r.b)("img",{alt:"img",src:n(151).default})),Object(r.b)("p",null,Object(r.b)("img",{alt:"img",src:n(152).default})),Object(r.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(r.b)("div",Object(o.a)({parentName:"div"},{className:"admonition-heading"}),Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",Object(o.a)({parentName:"h5"},{className:"admonition-icon"}),Object(r.b)("svg",Object(o.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(r.b)("path",Object(o.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(r.b)("div",Object(o.a)({parentName:"div"},{className:"admonition-content"}),Object(r.b)("p",{parentName:"div"},Object(r.b)("strong",{parentName:"p"},"A quick note on Topologies")),Object(r.b)("p",{parentName:"div"},"You may wonder why we only have a single Windows node. Is that enough? Here, you should make a choice of which Sitecore topology you wish to deploy. Sitecore themselves provide Kubernetes specifications for XM1 and XP1 topologies. I chose XM1 as this was my first attempt at a Sitecore Kubernetes deployment and I figured \u2013 less to go wrong!"),Object(r.b)("p",{parentName:"div"},"From here on out, assume that the steps relate to an XM1 deployment, but that the same approach can be followed for an XP1 deployment, with a little extra care. "))),Object(r.b)("h5",{id:"14--now-lets-grab-the-necessary-sitecore-installation-files"},"14.\t Now, lets grab the necessary Sitecore installation files."),Object(r.b)("p",null,"Go to the ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"https://dev.sitecore.net/Downloads/Sitecore_Experience_Platform/100/Sitecore_Experience_Platform_100_Update1.aspx"}),"Sitecore 10 Release Page")," and follow the link to the correct ",Object(r.b)("inlineCode",{parentName:"p"},"SXP Sitecore Container Deployment")," zip file. The one I used was ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"https://github.com/Sitecore/container-deployment/releases/tag/sxp%2F10.0.1.004842.266"}),"10.0.1.004842.266")," \u2013 but as new updates come out, you may want to use the latest. "),Object(r.b)("h5",{id:"15--expand-the-zip-and-copy-the-contents-of-the-k8sltsc2019xm1-folder-to-a-working-area-somewhere-in-easy-reach-of-your-powershell-session"},"15.\t Expand the zip and copy the contents of the k8s/ltsc2019/xm1 folder to a working area, somewhere in easy reach of your Powershell session."),Object(r.b)("h5",{id:"16--populate-the-secrets"},"16.\t Populate the secrets."),Object(r.b)("p",null,"Within the secrets folder, make sure that all ",Object(r.b)("inlineCode",{parentName:"p"},".txt")," files are populated and that you\u2019ve placed certificates into the ",Object(r.b)("inlineCode",{parentName:"p"},"tls")," folders. The easiest way to get all of the values you need here, in the correct formats, is to use the Getting Started Powershell configuration script from here: ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"https://github.com/Sitecore/docker-examples/blob/develop/getting-started/init.ps1"}),"https://github.com/Sitecore/docker-examples/blob/develop/getting-started/init.ps1")," "),Object(r.b)("p",null,"When everything is ready, you will have a values in all ",Object(r.b)("inlineCode",{parentName:"p"},".txt")," files and a ",Object(r.b)("inlineCode",{parentName:"p"},"tls.crt")," / ",Object(r.b)("inlineCode",{parentName:"p"},"tls.key")," file in each of the subfolders of ",Object(r.b)("inlineCode",{parentName:"p"},"/tls/")),Object(r.b)("h3",{id:"deploy"},"Deploy!"),Object(r.b)("h5",{id:"17-the-first-deployment-task-is-for-the-ingress-controller-for-our-cluster-begin-by-adding-the-help-chart-repository"},"17.\tThe first deployment task is for the ingress controller for our cluster. Begin by adding the help chart repository:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"# helm repo add stable https://kubernetes-charts.storage.googleapis.com/\n")),Object(r.b)("p",null,"Is now deprecated, so use the following repo instead: "),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"helm repo add stable https://charts.helm.sh/stable\n")),Object(r.b)("p",null,Object(r.b)("img",{alt:"img",src:n(153).default})),Object(r.b)("h5",{id:"18--now-we-can-use-helm-to-install-our-ingress-controller-which-is-based-on-nginx"},"18.\t Now we can use helm to install our ingress controller, which is based on Nginx:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),'helm install nginx-ingress stable/nginx-ingress --set controller.replicaCount=1 --set controller.nodeSelector."beta\\.kubernetes\\.io/os"=linux --set defaultBackend.nodeSelector."beta\\.kubernetes\\.io/os"=linux --set-string controller.config.proxy-body-size=10m --set controller.service.externalTrafficPolicy=Local\n')),Object(r.b)("h5",{id:"19-wait-until-the-new-pods-are-running"},"19.\tWait until the new pods are running:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"kubectl get pods \n")),Object(r.b)("p",null,Object(r.b)("img",{alt:"img",src:n(154).default})),Object(r.b)("h5",{id:"20-deploy-the-secrets-we-just-configured"},"20.\tDeploy the secrets we just configured:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"kubectl apply -k ./secrets/\n")),Object(r.b)("p",null,Object(r.b)("img",{alt:"img",src:n(155).default})),Object(r.b)("h5",{id:"21--for-our-initial-deployment-well-run-solr-and-mssql-inside-containers--this-speeds-up-our-workflow-to-get-a-sitecore-instance-running-in-production-youll-want-to-swap-these-out-for-managed-services"},"21.\t For our initial deployment, we\u2019ll run Solr and MSSQL inside containers \u2013 this speeds up our workflow to get a Sitecore instance running. In production, you\u2019ll want to swap these out for managed services."),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"kubectl apply -f ./external/\n")),Object(r.b)("h5",{id:"22-once-our-solr-and-mssql-containers-are-in-the-running-state-we-can-initialise-them-with-data"},"22.\tOnce our Solr and MSSQL containers are in the \u201cRunning\u201d state, we can initialise them with data:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"kubectl apply -f ./init/\n")),Object(r.b)("h5",{id:"23-at-last--its-the-time-to-deploy-our-sitecore-cm-cd-and-id-containers"},"23 At last \u2013 it\u2019s the time to deploy our Sitecore CM, CD and ID containers!"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"kubectl apply -f ./\n")),Object(r.b)("p",null,Object(r.b)("img",{alt:"img",src:n(156).default})),Object(r.b)("h5",{id:"24-now-that-our-sitecore-containers-are-running-lets-update-our-ingress-controller-to-enable-traffic-to-flow-through-our-cluster"},"24. Now that our Sitecore containers are running, let\u2019s update our Ingress controller to enable traffic to flow through our cluster:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"kubectl apply -f ./ingress-nginx/ingress.yaml\n")),Object(r.b)("h3",{id:"test-the-deployment"},"Test the deployment"),Object(r.b)("h5",{id:"25-at-this-point-your-deployments-should-be-working-away-run-the-following-commands-to-check-on-their-status"},"25. At this point, your deployments should be working away. Run the following commands to check on their status:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"kubectl get pods \nkubectl get service -l app=nginx-ingress\n")),Object(r.b)("p",null,Object(r.b)("img",{alt:"img",src:n(157).default})),Object(r.b)("h5",{id:"26-once-your-deployment-is-complete-grab-the-external-ip-shown-above-we-can-use-nslookup-to-find-the-ip-address-to-add-to-our-hosts-file"},"26. Once your deployment is complete, grab the EXTERNAL-IP shown above. We can use NSLOOKUP to find the IP address to add to our hosts file."),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"nslookup ABC-115789212.eu-north-1.elb.amazonaws.com\n")),Object(r.b)("p",null,Object(r.b)("img",{alt:"img",src:n(158).default})),Object(r.b)("h5",{id:"27-add-this-to-your-hosts-file"},"27. Add this to your hosts file"),Object(r.b)("p",null,Object(r.b)("img",{alt:"img",src:n(159).default})),Object(r.b)("h5",{id:"28-open-up-a-browser-and-navigate-to-cmglobalhostsitecore--if-everything-went-to-plan-youll-see-the-sitecore-login-page"},"28. Open up a browser and navigate to cm.globalhost/sitecore \u2013 if everything went to plan, you\u2019ll see the Sitecore login page!"),Object(r.b)("p",null,Object(r.b)("img",{alt:"img",src:n(160).default})),Object(r.b)("h3",{id:"destroy-all-the-things"},"Destroy all the things"),Object(r.b)("h5",{id:"29-once-youre-done-and-happy-with-your-experiment-you-can-destroy-the-cluster"},"29. Once you\u2019re done and happy with your experiment, you can destroy the cluster:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"eksctl delete cluster \u2013name=sitecore-10-cluster\n")),Object(r.b)("p",null,Object(r.b)("img",{alt:"img",src:n(161).default})),Object(r.b)("h3",{id:"troubleshooting"},"Troubleshooting"),Object(r.b)("p",null,"While deploying to EKS, I hit a few problems - mostly with invalid configurations, which I've since corrected in the steps above. However, it's handy to know how to peek inside your cluster and get more information about troubled pods and nodes. "),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"kubectl get pods\n")),Object(r.b)("p",null,"get pods will show you a list of pods - you can then use the name of an individual pod to get detailed information on that pod: "),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"kubectl describe pod my-pod\n")),Object(r.b)("p",null,"If there's a problem with your cluster or a particular pod, you may be able to surface the error by looking in the Kubernetes event log: "),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-powershell"}),"kubectl get events\n")),Object(r.b)("h3",{id:"conclusion"},"Conclusion"),Object(r.b)("p",null,"In this post, we've gone from an empty AWS EKS service to having a fully working Kubernetes cluster, complete with Windows worker node and running Sitecore 10. Excellent work! The team at Sitecore have put in a huge amount of work to make this deployment method available to us, and I've been really impressed with how things work. "),Object(r.b)("p",null,"There are plenty of next steps - replacing the data services (Solr, MSSQL) with managed AWS services - achieving a more production-like environment with multiple nodes - scaling up and down. "),Object(r.b)("p",null,"I hope to blog more about these topics in the coming months. "),Object(r.b)("p",null,"Have fun!"))}b.isMDXComponent=!0},99:function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return h}));var o=n(0),a=n.n(o);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=a.a.createContext({}),b=function(e){var t=a.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=b(e.components);return a.a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},p=a.a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),u=b(n),p=o,h=u["".concat(s,".").concat(p)]||u[p]||d[p]||r;return n?a.a.createElement(h,i(i({ref:t},l),{},{components:n})):a.a.createElement(h,i({ref:t},l))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,s=new Array(r);s[0]=p;var i={};for(var c in t)hasOwnProperty.call(t,c)&&(i[c]=t[c]);i.originalType=e,i.mdxType="string"==typeof e?e:o,s[1]=i;for(var l=2;l<r;l++)s[l]=n[l];return a.a.createElement.apply(null,s)}return a.a.createElement.apply(null,n)}p.displayName="MDXCreateElement"}}]);