(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{78:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return l})),n.d(t,"metadata",(function(){return i})),n.d(t,"toc",(function(){return c})),n.d(t,"default",(function(){return p}));var r=n(3),o=n(7),a=(n(0),n(91)),l={id:"sitecore_mvc_internals_factory",title:"Sitecore MVC internals - SitecoreControllerFactory"},i={unversionedId:"sitecore_mvc_internals_factory",id:"sitecore_mvc_internals_factory",isDocsHomePage:!1,title:"Sitecore MVC internals - SitecoreControllerFactory",description:"In this post, the first in a series of posts looking into the internals of Sitecore MVC, we\u2019ll be looking at the SitecoreControllerFactory class in detail.",source:"@site/docs/2017_sitecore_internals_factory.md",slug:"/sitecore_mvc_internals_factory",permalink:"/sitecore_mvc_internals_factory",version:"current",sidebar:"someSidebar",previous:{title:"Sitecore MVC Internals - IControllerActivator",permalink:"/sitecore_mvc_internals"},next:{title:"C# Async functionality testing with xUnit",permalink:"/async_functionality_testing_with_xunit"}},c=[{value:"What does SitecoreControllerFactory do?",id:"what-does-sitecorecontrollerfactory-do",children:[]},{value:"Back to Sitecore",id:"back-to-sitecore",children:[]}],s={toc:c};function p(e){var t=e.components,n=Object(o.a)(e,["components"]);return Object(a.b)("wrapper",Object(r.a)({},s,n,{components:t,mdxType:"MDXLayout"}),Object(a.b)("p",null,"In this post, the first in a series of posts looking into the internals of Sitecore MVC, we\u2019ll be looking at the ",Object(a.b)("inlineCode",{parentName:"p"},"SitecoreControllerFactory")," class in detail."),Object(a.b)("h3",{id:"what-does-sitecorecontrollerfactory-do"},"What does SitecoreControllerFactory do?"),Object(a.b)("p",null,"This class, provided by Sitecore in the ",Object(a.b)("inlineCode",{parentName:"p"},"Sitecore.Mvc.Controllers")," namespace, is responsible for creating an instance of an MVC controller, used by Sitecore for turning a HTTP request (for say, ",Object(a.b)("inlineCode",{parentName:"p"},"/products/12345"),") into a HTML response, rendered by the browser."),Object(a.b)("p",null,"The concept of a Controller Factory is not specific to Sitecore, and is one of the mechanics of the wider ASP.NET MVC framework. Let\u2019s look at the signature for this class."),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"public class SitecoreControllerFactory : IControllerFactory\n")),Object(a.b)("p",null,"Here we\u2019re seeing a Sitecore class, ",Object(a.b)("inlineCode",{parentName:"p"},"SitecoreControllerFactory"),", implement an interface, ",Object(a.b)("inlineCode",{parentName:"p"},"IControllerFactory"),", which belongs to the wider ASP.NET MVC framework. ",Object(a.b)("inlineCode",{parentName:"p"},"IControllerFactory")," defines one method we\u2019re interested in here:"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"public interface IControllerFactory\n{\n    IController CreateController(RequestContext requestContext, string controllerName);\n    //..others\n}\n")),Object(a.b)("p",null,"This means that ",Object(a.b)("inlineCode",{parentName:"p"},"SitecoreControllerFactory")," must implement a method called ",Object(a.b)("inlineCode",{parentName:"p"},"CreateController"),". Similarly, any non-Sitecore sites you build using ASP.NET MVC will likely use the built-in ",Object(a.b)("inlineCode",{parentName:"p"},"DefaultControllerFactory")," class that Microsoft provide for you. It\u2019s happening behind the scenes, and unless you needed to do some heavy customisation to your project, you may not have noticed. Before we get back to Sitecore, let\u2019s look at Microsoft\u2019s implementation of ",Object(a.b)("inlineCode",{parentName:"p"},"CreateController"),", in their vanilla ",Object(a.b)("inlineCode",{parentName:"p"},"IControllerFactory")," implementation, ",Object(a.b)("inlineCode",{parentName:"p"},"DefaultControllerFactory"),":"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"public class DefaultControllerFactory : IControllerFactory\n{\n    //.. snipped\n    public virtual IController CreateController(RequestContext requestContext, string controllerName)\n    {\n      //.. snipped\n      Type controllerType = this.GetControllerType(requestContext, controllerName);\n      return this.GetControllerInstance(requestContext, controllerType); \n    }\n}\n")),Object(a.b)("p",null,"So, Microsoft\u2019s default ",Object(a.b)("inlineCode",{parentName:"p"},"CreateController")," implementation returns a ",Object(a.b)("inlineCode",{parentName:"p"},"Controller")," object. How does this method know which ",Object(a.b)("inlineCode",{parentName:"p"},"Controller")," you want? Well, we break it up into two steps. First, we pass a controller name (such as \u2018Products\u2019) to the method. This name is taken from the route data extracted from our request to ",Object(a.b)("inlineCode",{parentName:"p"},"/products/12345"),". This controller name is passed to the ",Object(a.b)("inlineCode",{parentName:"p"},"GetControllerType")," method, which finds the appropriate Controller Type."),Object(a.b)("p",null,"Secondly, we pass this Type to another method, ",Object(a.b)("inlineCode",{parentName:"p"},"GetControllerInstance"),", which handles the actual instantiation of the new Controller object, which we\u2019ll eventually return. ",Object(a.b)("inlineCode",{parentName:"p"},"GetControllerInstance")," makes use of another MVC feature called ",Object(a.b)("inlineCode",{parentName:"p"},"Activators"),", which we\u2019ll handle in another blog post."),Object(a.b)("p",null,"So why do we need all of these steps, just to instantiate a ",Object(a.b)("inlineCode",{parentName:"p"},"Controller")," object?"),Object(a.b)("p",null,"ASP.NET MVC was built with a few design goals in mind \u2013 mainly testability and extensibility. One way of achieving these goals was to include wide support for dependency injection. In short \u2013 each of these steps can be replaced with our implementation, should we need to. And handily, that brings us back to Sitecore."),Object(a.b)("h3",{id:"back-to-sitecore"},"Back to Sitecore"),Object(a.b)("p",null,"Now we know that ASP.NET MVC makes it easy for us to replace any of the default behaviour for our own, bespoke implementations, we can look at one instance of where Sitecore have done exactly that. Sitecore\u2019s ",Object(a.b)("inlineCode",{parentName:"p"},"SitecoreControllerFactory")," class implements ",Object(a.b)("inlineCode",{parentName:"p"},"IControllerFactory"),", and is used in place of Microsoft\u2019s ",Object(a.b)("inlineCode",{parentName:"p"},"DefaultControllerFactory"),"."),Object(a.b)("p",null,"Let\u2019s look at ",Object(a.b)("inlineCode",{parentName:"p"},"SitecoreControllerFactory\u2019s")," ",Object(a.b)("inlineCode",{parentName:"p"},"CreateController")," method:"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"public virtual IController CreateController(RequestContext requestContext, string controllerName)\n{\n    //snipped\n    IController controllerInstance = this.CreateControllerInstance(requestContext, controllerName);\n    this.PrepareController(controllerInstance, controllerName);\n    return controllerInstance;\n}\n")),Object(a.b)("p",null,"This method doesn\u2019t do much more than call two other methods \u2013 ",Object(a.b)("inlineCode",{parentName:"p"},"CreateControllerInstance")," and ",Object(a.b)("inlineCode",{parentName:"p"},"PrepareController"),". The main work we\u2019re interested in here is in ",Object(a.b)("inlineCode",{parentName:"p"},"CreateControllerInstance"),", so let\u2019s follow along that thread:"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"protected virtual IController CreateControllerInstance(RequestContext requestContext, string controllerName)\n{\n    if (controllerName.EqualsText(this.SitecoreControllerName))\n    return this.CreateSitecoreController(requestContext, controllerName);\n\n    if (TypeHelper.LooksLikeTypeName(controllerName))\n    {\n        Type type = TypeHelper.GetType(controllerName);\n        if (type != (Type)null)\n            return TypeHelper.CreateObject(type);\n        }\n\n    return this.InnerFactory.CreateController(requestContext, controllerName);\n}\n")),Object(a.b)("p",null,"So, there are three ways in which Sitecore can choose to instantiate a ",Object(a.b)("inlineCode",{parentName:"p"},"Controller"),"! This seems a little more involved than Microsoft\u2019s default implementation, but this is Sitecore, so that seems reasonable. Let\u2019s follow down the path of ",Object(a.b)("inlineCode",{parentName:"p"},"CreateSitecoreController"),"."),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),'protected virtual IController CreateSitecoreController(RequestContext requestContext, string controllerName)\n{\n    IController controller = PipelineService.Get().RunPipeline("mvc.createController", \n        new CreateControllerArgs(requestContext, controllerName), \n        (Func)(args => args.Result));\n}\n')),Object(a.b)("p",null,"Ok! We\u2019re now back firmly in Sitecore territory. Here\u2019s where we branch from the way vanilla ASP.NET MVC does things, and how Sitecore handles things. Just like in standard ASP.NET MVC, we have a request context and a ",Object(a.b)("inlineCode",{parentName:"p"},"Controller")," name. However, instead of handing it off to ",Object(a.b)("inlineCode",{parentName:"p"},"GetControllerInstance")," as we did in ",Object(a.b)("inlineCode",{parentName:"p"},"DefaultControllerFactory"),", we call upon a Sitecore Pipeline, called ",Object(a.b)("inlineCode",{parentName:"p"},"mvc.createController"),"."),Object(a.b)("p",null,"This pipeline handles the instantiation of ",Object(a.b)("inlineCode",{parentName:"p"},"Controller")," objects by pulling some relevant details from Sitecore:"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),'string controllerName = ((BaseItem) item).get_Item("__Controller");\n\nstring actionName = ((BaseItem) item).get_Item("__Controller Action");\n')),Object(a.b)("p",null,"Finally, we know which ",Object(a.b)("inlineCode",{parentName:"p"},"Controller")," should be used for the Sitecore item being requested (remember? ",Object(a.b)("inlineCode",{parentName:"p"},"/Products/12345"),"). To handle the actual instantiation of the item, Sitecore gives us two ways to do this, both called from the ",Object(a.b)("inlineCode",{parentName:"p"},"mvc.createController")," pipeline:"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"IController CreateControllerUsingFactory()\n\nIController CreateControllerUsingReflection()\n")),Object(a.b)("p",null,"The difference? Well, we can actually invoke another ",Object(a.b)("inlineCode",{parentName:"p"},"IControllerFactory")," instance to do the creation work for us. Think of this as Sitecore playing nicely \u2013 the ",Object(a.b)("inlineCode",{parentName:"p"},"SitecoreControllerFactory")," does only what it needs to, retrieving the details of which controller we need; it then relinquishes control of the actual instantiation of that controller to any other ",Object(a.b)("inlineCode",{parentName:"p"},"IControllerFactory")," you want to use. Sitecore wraps this detail up in a ",Object(a.b)("inlineCode",{parentName:"p"},"ControllerSpecification"),", however we\u2019ll leave it there for now. This is something we\u2019ll address in another post."),Object(a.b)("p",null,"If no ",Object(a.b)("inlineCode",{parentName:"p"},"ControllerSpecification")," is given, then we can fall back to good old Reflection to create our instance."),Object(a.b)("p",null,"I hope you\u2019ve enjoyed this peek into the workings of Sitecore MVC. There\u2019s plenty more to be discovered, so happy digging!"))}p.isMDXComponent=!0},91:function(e,t,n){"use strict";n.d(t,"a",(function(){return b})),n.d(t,"b",(function(){return m}));var r=n(0),o=n.n(r);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=o.a.createContext({}),p=function(e){var t=o.a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},b=function(e){var t=p(e.components);return o.a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.a.createElement(o.a.Fragment,{},t)}},d=o.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,l=e.parentName,s=c(e,["components","mdxType","originalType","parentName"]),b=p(n),d=r,m=b["".concat(l,".").concat(d)]||b[d]||u[d]||a;return n?o.a.createElement(m,i(i({ref:t},s),{},{components:n})):o.a.createElement(m,i({ref:t},s))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,l=new Array(a);l[0]=d;var i={};for(var c in t)hasOwnProperty.call(t,c)&&(i[c]=t[c]);i.originalType=e,i.mdxType="string"==typeof e?e:r,l[1]=i;for(var s=2;s<a;s++)l[s]=n[s];return o.a.createElement.apply(null,l)}return o.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);