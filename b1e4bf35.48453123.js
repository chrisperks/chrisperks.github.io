(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{102:function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return m}));var r=n(0),a=n.n(r);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var b=a.a.createContext({}),l=function(e){var t=a.a.useContext(b),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},u=function(e){var t=l(e.components);return a.a.createElement(b.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},d=a.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,c=e.parentName,b=i(e,["components","mdxType","originalType","parentName"]),u=l(n),d=r,m=u["".concat(c,".").concat(d)]||u[d]||p[d]||o;return n?a.a.createElement(m,s(s({ref:t},b),{},{components:n})):a.a.createElement(m,s({ref:t},b))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,c=new Array(o);c[0]=d;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s.mdxType="string"==typeof e?e:r,c[1]=s;for(var b=2;b<o;b++)c[b]=n[b];return a.a.createElement.apply(null,c)}return a.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},92:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return c})),n.d(t,"metadata",(function(){return s})),n.d(t,"toc",(function(){return i})),n.d(t,"default",(function(){return l}));var r=n(3),a=n(7),o=(n(0),n(102)),c={id:"sitecore_10_production_aws_deploys",title:"Production Sitecore 10 AWS EKS deploys - connecting VPCs"},s={unversionedId:"sitecore_10_production_aws_deploys",id:"sitecore_10_production_aws_deploys",isDocsHomePage:!1,title:"Production Sitecore 10 AWS EKS deploys - connecting VPCs",description:"The next step in readying a Kubernetes-powered AWS EKS Sitecore 10 deployment for deployment is moving the data services (Solr, MS SQL) outside of the Kubernetes cluster.",source:"@site/docs/2021_sitecore_10_production_aws_deploys.md",slug:"/sitecore_10_production_aws_deploys",permalink:"/sitecore_10_production_aws_deploys",version:"current"},i=[],b={toc:i};function l(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(o.b)("wrapper",Object(r.a)({},b,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"The next step in readying a Kubernetes-powered AWS EKS Sitecore 10 deployment for deployment is moving the data services (Solr, MS SQL) outside of the Kubernetes cluster. "),Object(o.b)("p",null,"While the Kubernetes product (develops a capability)","[https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/]"," for running stateful workloads, it is still best practice to keep Kubernetes for your stateless compute tasks, and run databases outside of the cluster. "),Object(o.b)("p",null,"Options on AWS "),Object(o.b)("p",null,"There are two ",Object(o.b)("em",{parentName:"p"},"mainstream")," options available to host your SQL Server instance on AWS. Both have pros and cons, and we'll quickly summarise here. "),Object(o.b)("p",null,"AWS RDS"),Object(o.b)("p",null,"RDS is a managed database product. A SQL Server instance can be provisioned through the usual channels (AWS Console, AWS CLI) and the infrastructure management (including backups) is taken care of. "),Object(o.b)("p",null,"Pros"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"Low administration burden, easy scaling, easy multi-AZ setup, automated backups and snapshots")),Object(o.b)("p",null,"Cons"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"AWS does not grant you an administrator account with all abilities. Running the Sitecore 10 Kubernetes mssql-init job against an RDS database will surface many permissions errors.")),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"The database settings cannot be modified. You must be a SysAdmin to apply these settings.\n\nProcedure sys.sp_configure, Line 105\nUser does not have permission to perform this action.\n\nDeployed Sitecore.Experienceforms database\nStart creating database 'Sitecore.Master' with azure elastic pool 'pool'\nMsg 102, Level 15, State 1, Server, Line 2\nIncorrect syntax near '('.\n\nMsg 12824, Level 16, State 1, Server, Line 1\nThe sp_configure value 'contained database authentication' must be set to 1 in order to alter a contained database.  You may need to use RECONFIGURE to set the value_in_use.\nMsg 5069, Level 16, State 1, Server , Line 1\nALTER DATABASE statement failed.\n\nYou can only create a user with a password in a contained database.\nMsg 15410, Level 11, State 1, Server, Procedure sp_addrolemember, Line 35\n\nThe sp_configure value 'contained database authentication' must be set to 1 in order to alter a contained database.  You may need to use RECONFIGURE to set the value_in_use.\n\nYou do not have permission to run the RECONFIGURE statement\n")),Object(o.b)("p",null,"Workarounds exist, but the main path to production deployment is still the import of an existing Sitecore database into RDS - which won't suit all workflows. "),Object(o.b)("p",null,"SQL Server on Amazon EC2 instances"),Object(o.b)("p",null,"Both Windows and Linux instance can now run SQL Server, so this is a great fallback option for when you don't want to re-work installation processes to be compatible with RDS. "),Object(o.b)("p",null,"Pros"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"Full control, simply a database in the cloud"),Object(o.b)("li",{parentName:"ul"},"Can use existing Sitecore 10 database initialisation methods")),Object(o.b)("p",null,"Cons"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"Administration burden. Backups, scaling, failover - they're all on you. ")),Object(o.b)("p",null,"A common configuration - separate VPCs"),Object(o.b)("p",null,"Whichever approach you choose, it is a common security and management practice to run your database workloads in a separate VPC to your EKS cluster. You may want the safety of a different security profile for your database, or monitor the VPCs using separate tooling. "),Object(o.b)("p",null,"Connecting an RDS VPC to your Sitecore EKS cluster"),Object(o.b)("ol",null,Object(o.b)("li",{parentName:"ol"},"Install jq to Powershell - we'll use this to view the outputs of our AWS service creation")),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"chocolatey install jq\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),'aws ec2 create-vpc --cidr-block 10.0.0.0/24 | jq \'{VpcId:.Vpc.VpcId,CidrBlock:.Vpc.CidrBlock}\'\n{\n  "VpcId": "vpc-0905280971bf101a2",\n  "CidrBlock": "10.0.0.0/24"\n}\n')),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),'$Env:RDS_VPC_ID="vpc-0b6fb5c403d053bb3"\n')),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"aws ec2 create-subnet --availability-zone \"eu-north-1b\" --vpc-id $Env:RDS_VPC_ID --cidr-block 10.0.0.0/25 | jq '{SubnetId:.Subnet.SubnetId,AvailabilityZone:.Subnet.AvailabilityZone,CidrBlock:.Subnet.CidrBlock,VpcId:.Subnet.VpcId}'\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"aws ec2 create-subnet --availability-zone \"eu-north-1a\" --vpc-id $Env:RDS_VPC_ID --cidr-block 10.0.0.128/25 | jq '{SubnetId:.Subnet.SubnetId,AvailabilityZone:.Subnet.AvailabilityZone,CidrBlock:.Subnet.CidrBlock,VpcId:.Subnet.VpcId}'\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"aws ec2 describe-route-tables --filters Name=vpc-id,Values=$Env:RDS_VPC_ID | jq '.RouteTables[0].RouteTableId'\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),'$Env:RDS_ROUTE_TABLE_ID="rtb-0ff833750c0039dbf"                                                             \n')),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"aws ec2 associate-route-table --route-table-id rtb-0ff833750c0039dbf --subnet-id subnet-0fe72fea5487d0daf\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),'aws rds create-db-subnet-group --db-subnet-group-name  "DemoDBSubnetGroup" --db-subnet-group-description "Demo DB Subnet Group" --subnet-ids "subnet-0fe72fea5487d0daf" "subnet-0f3201b8ea9fb1147" | jq \'{DBSubnetGroupName:.DBSubnetGroup.DBSubnetGroupName,VpcId:.DBSubnetGroup.VpcId,Subnets:.DBSubnetGroup.Subnets[].SubnetIdentifier}\'\n')),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),'aws ec2 create-security-group --group-name DemoRDSSecurityGroup --description "Demo RDS security group" --vpc-id $Env:RDS_VPC_ID\n')),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),'$Env:RDS_VPC_SECURITY_GROUP_ID="sg-045d5de71c4b7ff17"\n')),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),'aws rds create-db-instance `\n   --db-instance-identifier demordsmssqldbdbinstance `\n   --allocated-storage 20 `\n   --db-instance-class db.t3.small `\n   --engine sqlserver-ex `\n   --engine-version "15.00.4073.23.v1" `\n   --master-username admin `\n   --storage-type standard `\n   --master-user-password zXQQVXvcg2CTf2bH `\n   --no-publicly-accessible `\n   --vpc-security-group-ids $Env:RDS_VPC_SECURITY_GROUP_ID `\n   --db-subnet-group-name "demodbsubnetgroup" `\n   --availability-zone eu-north-1b `\n   --port 1433 | jq \'{DBInstanceIdentifier:.DBInstance.DBInstanceIdentifier,Engine:.DBInstance.Engine,DBName:.DBInstance.DBName,VpcSecurityGroups:.DBInstance.VpcSecurityGroups,EngineVersion:.DBInstance.EngineVersion,PubliclyAccessible:.DBInstance.PubliclyAccessible}\'\n')),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"# sql-service.yaml \napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: sql-service\n  name: sql-service\nspec:\n  externalName: demordsmssqldbdbinstance.ccysvgfv15nu.eu-north-1.rds.amazonaws.com\n  selector:\n    app: sql-service\n  type: ExternalName\nstatus:\n  loadBalancer: {}\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"kubectl apply -f .\\sql-service.yaml\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),'$Env:VPC_PEERING_CONNECTION_ID="pcx-05626fc86f371fd76"\n')),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),'aws ec2 describe-route-tables --filters Name="tag:aws:cloudformation:logical-id",Values="PublicRouteTable" | jq \'.RouteTables[0].RouteTableId\'\n')),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),'$Env:EKS_ROUTE_TABLE_ID="rtb-0bf8ca168c87e02c9"\n')),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"aws ec2 create-route --route-table-id $Env:EKS_ROUTE_TABLE_ID --destination-cidr-block 10.0.0.0/24 --vpc-peering-connection-id $Env:VPC_PEERING_CONNECTION_ID\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"aws ec2 create-route --route-table-id $Env:RDS_ROUTE_TABLE_ID --destination-cidr-block 192.168.0.0/16 --vpc-peering-connection-id $Env:VPC_PEERING_CONNECTION_ID\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"aws ec2 authorize-security-group-ingress --group-id $Env:RDS_VPC_SECURITY_GROUP_ID --protocol tcp --port 1433 --cidr 192.168.0.0/16\n")))}l.isMDXComponent=!0}}]);