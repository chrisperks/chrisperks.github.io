(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{102:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return d}));var r=n(0),a=n.n(r);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=a.a.createContext({}),u=function(e){var t=a.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):c(c({},t),e)),n},p=function(e){var t=u(e.components);return a.a.createElement(l.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},m=a.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),p=u(n),m=r,d=p["".concat(i,".").concat(m)]||p[m]||b[m]||o;return n?a.a.createElement(d,c(c({ref:t},l),{},{components:n})):a.a.createElement(d,c({ref:t},l))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=m;var c={};for(var s in t)hasOwnProperty.call(t,s)&&(c[s]=t[s]);c.originalType=e,c.mdxType="string"==typeof e?e:r,i[1]=c;for(var l=2;l<o;l++)i[l]=n[l];return a.a.createElement.apply(null,i)}return a.a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},78:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return c})),n.d(t,"toc",(function(){return s})),n.d(t,"default",(function(){return u}));var r=n(3),a=n(7),o=(n(0),n(102)),i={id:"lucene_explain",title:"Explaining Lucene explain"},c={unversionedId:"lucene_explain",id:"lucene_explain",isDocsHomePage:!1,title:"Explaining Lucene explain",description:"Each time you perform a search using Lucene, a score is applied to the results returned by your query.",source:"@site/docs/2017_lucene_explain.md",slug:"/lucene_explain",permalink:"/lucene_explain",version:"current",sidebar:"someSidebar",previous:{title:"Sitecore Solr setup - Document is missing mandatory uniqueKey field id",permalink:"/missing_uniquekey"},next:{title:"Visualising Sitecore Analyzers",permalink:"/sitecore_analyzers"}},s=[],l={toc:s};function u(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(o.b)("wrapper",Object(r.a)({},l,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"Each time you perform a search using Lucene, a score is applied to the results returned by your query."),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"--------------------------------------\n| #   | Score | Tags                 |\n--------------------------------------\n| 343 | 2.319 | Movies, Action       |\n| 201 | 2.011 | Music, Classical     |\n| 454 | 1.424 | Movies, Kids         |\n| 012 | 0.003 | Music, Kids          |\n --------------------------------------\n")),Object(o.b)("p",null,"In our index, # is the unique document number, score is the the closeness of each hit to our query, and tags is a text field belonging to a document."),Object(o.b)("p",null,"There are many methods Lucene can use to calculate scoring. By default, we use the DefaultSimilarity implementation of the Similarity abstract class. This class implements the commonly referenced TfIdf scoring formula:"),Object(o.b)("p",null,"(more: ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://lucene.apache.org/core/3_0_3/api/core/org/apache/lucene/search/Similarity.html"}),"https://lucene.apache.org/core/3_0_3/api/core/org/apache/lucene/search/Similarity.html"),")"),Object(o.b)("p",null,"If you\u2019re new to Lucene (or even if you\u2019re not!) this formula can be a bit to get your head around. To get inside the formula for a given search result, Lucene provides an explanation feature, which we can call from code (c# example in Lucene.Net):"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"public List GetExplainerByRawQuery(string rawQuery, int doc = 0)\n{\n    using (var searcher = new IndexSearcher(_directory, false))\n    {\n        // Create a parser, and parse a plain-text query which searches for items tagged with 'movies' or 'kids' (or hopefully, both)\n        var parser = new QueryParser(Lucene.Net.Util.Version.LUCENE_30, \"id\", analyzer);\n        var query = parser.Parse(\"tags:(movies OR kids)\");\n\n        // Get references to the top 25 results\n        var hits = searcher.Search(query, 25).ScoreDocs;\n\n        // For each hit, get the accompanying explanation plan. We now have a List\n        var explains = hits.Select((x, i) => searcher.Explain(query, i)).ToList();\n\n        //Clean up and return\n        analyzer.Close();\n        searcher.Dispose();\n        return explains;\n    }\n}\n")),Object(o.b)("p",null,"Calling searcher.Explain(query, match.doc) gives us a text output explanation of how the matched document scores against the query:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"query: tags:movies|kids\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"----------------------------------------------------\n| #   | Score  | Tags                              |\n----------------------------------------------------\n| 127 | 2.4824 | Movies, Kids, Animation, Movies   |\n----------------------------------------------------\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"2.4824  sum of:\n  1.4570  weight(tags:movies in 127) [DefaultSimilarity], result of:\n    1.4570  score(doc=127,freq=2.0 = termFreq=2.0), product of:\n      0.7079  queryWeight, product of:\n        2.9105  idf(docFreq=147, maxDocs=1000)\n        0.2432  queryNorm\n      2.0581  fieldWeight in 127, product of:\n        1.4142  tf(freq=2.0), with freq of:\n          2.0000  termFreq=2.0\n        2.9105  idf(docFreq=147, maxDocs=1000)\n        0.5000  fieldNorm(doc=127)\n  1.0255  weight(tags:kids in 127) [DefaultSimilarity], result of:\n    1.0255  score(doc=127,freq=1.0 = termFreq=1.0), product of:\n      0.7063  queryWeight, product of:\n        2.9038  idf(docFreq=148, maxDocs=1000)\n        0.2432  queryNorm\n      1.4519  fieldWeight in 127, product of:\n        1.0000  tf(freq=1.0), with freq of:\n          1.0000  termFreq=1.0\n        2.9038  idf(docFreq=148, maxDocs=1000)\n        0.5000  fieldNorm(doc=127)\n\n")),Object(o.b)("p",null,"Ok! But still, there\u2019s a lot going on in there. Let\u2019s try and break it down."),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"2.4824 is the total score for this single search result. As our query contained two terms, \u2018movies\u2019 and \u2018kids\u2019, Lucene breaks the overall query down into two subqueries."),Object(o.b)("li",{parentName:"ul"},"The sum of the two subqueries (1.4570 for \u2018movies\u2019 and 1.0255 for \u2018kids\u2019) are added to arrive at our total score.")),Object(o.b)("p",null,"For our first subquery, the \u2018movies\u2019 part, we arrive at the score of 1.4570 by multiplying queryWeight (0.709) by fieldWeight (2.0581). Let\u2019s go line by line:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"  1.4570  weight(tags:movies in 127) [DefaultSimilarity], result of:\n")),Object(o.b)("p",null,"\u2191 The total score for the \u2018movies\u2019 subquery is 1.4570. \u2018tags:movies\u2018 is the raw query, 127 is the individual document number we\u2019re examining, and DefaultSimilarity is the scoring mecahsnism we\u2019re using."),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"1.4570 score(doc=127,freq=2.0 = termFreq=2.0), product of:\n")),Object(o.b)("p",null,"\u2191 The term (\u2018movies\u2018) appears twice in the \u2018tags\u2018 field for document 127, so we get a term frequency of 2.0"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"0.7079 queryWeight, product of:\n")),Object(o.b)("p",null,"\u2191 queryWeight (0.7079) is how rare the search term is within the whole index \u2013 in our case, \u2018movies\u2018 appears in 147 out of the 1000 documents in our index.   This normalization factor is the same for all results returned by our query and just stops the queryWeight scores from becoming too exaggerated for any single result."),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"2.9105 idf(docFreq=147, maxDocs=1000)\n")),Object(o.b)("p",null," \u2191 This rarity is called inverse document frequency (idf)"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"0.2432 queryNorm\n")),Object(o.b)("p",null," \u2191 .. and is itself multiplied by a normalization factor (0.2432) called queryNorm.\nThis normalization factor is the same for all results returned by our query and just stops the queryWeight scores from becoming too exaggerated for any single result."),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"2.0581 fieldWeight in 127, product of:\n")),Object(o.b)("p",null," \u2191 fieldWeight (2.0581) is how often the search term (\u2018movies\u2018) appears in the field we searched on \u2018tags\u2019."),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"1.4142 tf(freq=2.0), with freq of:\n  2.0000 termFreq=2.0\n")),Object(o.b)("p",null,"  \u2191 We take the square root of the termFreq (2.0) = 1.4142"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"2.9105 idf(docFreq=147, maxDocs=1000)\n")),Object(o.b)("p",null," \u2191 This is multiplied by the idf which we calculated above (2.9105)"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"0.5000 fieldNorm(doc=127)\n")),Object(o.b)("p",null," \u2191  and finally by a field normalization factor (0.5000), which tells us how many overall terms were in the field.\nThis \u2018boost\u2018 value will be higher for shorter fields \u2013 meaning the more promenant your search term was in a field, the more relevant the result."),Object(o.b)("h4",{id:"further-reading"},"Further reading:"),Object(o.b)("p",null,Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"http://www.lucenetutorial.com/advanced-topics/scoring.html"}),"http://www.lucenetutorial.com/advanced-topics/scoring.html"),"\n",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://ayende.com/blog/166274/the-lucene-formula-tf-idf"}),"https://ayende.com/blog/166274/the-lucene-formula-tf-idf"),"\nHappy Lucene hacking!"),Object(o.b)("p",null,"When Sitecore indexes your content, Lucene analyzers work to break down your text into a series of individual tokens. For instance, a simple analyzer might convert input text to lowercase, split into separate words, and remove punctuation:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"input: Hi there! My name is Chris."),Object(o.b)("li",{parentName:"ul"},"output tokens: \u201chi\u201d, \u201cthere\u201d, \u201cmy\u201d, \u201cname\u201d, \u201cis\u201d, \u201cchris\u201d")),Object(o.b)("p",null,"While this happens behind the scenes, and is usually not of too much interest outside of diagnostics or curiosity, there\u2019s a way we can view the output of the analyzers bundled with Sitecore."),Object(o.b)("p",null,"Let\u2019s get some input text to analyze, in both English and French:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),'var text = "Did the Quick Brown Fox jump over the Lazy Dog?";\nvar text_fr = "Le Fox brune rapide a-t-il saut\xe9 sur le chien paresseux?";\n')),Object(o.b)("p",null,"Next, let\u2019s write a generic method which takes some text and a Lucene analyzer, and runs the text through the analyzer:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),'private static void displayTokens(Analyzer analyzer, string text)\n{\n    var stream = analyzer.TokenStream("content", new StringReader(text));\n    var term = stream.AddAttribute();\n    while (stream.IncrementToken())\n    {\n      Console.Write("\'" + term.Term + "\', ");\n    }\n}\n')),Object(o.b)("p",null,"Now, let\u2019s try this out on some Sitecore analyzers!"),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"CaseSensitiveStandardAnalyzer")," retains case, but removes punctuation and stop words (common words which offer no real value when searching)"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"displayTokens(new CaseSensitiveStandardAnalyzer(Lucene.Net.Util.Version.LUCENE_30), text);\n> 'Did', 'Quick', 'Brown', 'Fox', 'jump', 'over', 'Lazy', 'Dog'\n")),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"LowerCaseKeywordAnalyzer")," convers the input to lowercase, but retains the punctuation and doesn\u2019t split the input into separate words."),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"displayTokens(new LowerCaseKeywordAnalyzer(), text);\n> 'did the quick brown fox jump over the lazy dog?\n")),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"NGramAnalyzer")," breaks text up into trigrams which are useful for autocomplete. See more here."),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"displayTokens(new NGramAnalyzer(), text);\n> 'did_the_quick', 'the_quick_brown', 'quick_brown_fox', 'brown_fox_jump', 'fox_jump_over', 'jump_over_the', 'over_the_lazy', 'the_lazy_dog\n")),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"StandardAnalyzerWithStemming")," introduces stemming, which finds a common root for similar words (lazy, lazily, laze -> lazi)"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"displayTokens(new StandardAnalyzerWithStemming(Lucene.Net.Util.Version.LUCENE_30), text);\n> 'Did', 'the', 'Quick', 'Brown', 'Fox', 'jump', 'over', 'the', 'Lazi', 'Dog'\n")),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"SynonymAnalyzer")," uses a set of synonyms (in our case, defined in an XML file) to index synonyms (fast, rapid) along with the original word (quick). Read more: ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"http://firebreaksice.com/sitecore-synonym-search-with-lucene/"}),"http://firebreaksice.com/sitecore-synonym-search-with-lucene/")),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"displayTokens(new SynonymAnalyzer(new XmlSynonymEngine(\"synonyms.xml\")), text);\n> 'did', 'quick', 'fast', 'rapid', 'brown', 'fox', 'jump', 'over', 'lazy', 'dog\n")),Object(o.b)("p",null,"Lastly, we try a ",Object(o.b)("inlineCode",{parentName:"p"},"FrenchAnalyzer"),". Stop words are language specific, and so the community often contributes analyzers which will remove stop words in languages other than English. In the example below, we remove common French words."),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),"displayTokens(new FrenchAnalyzer(Lucene.Net.Util.Version.LUCENE_30), text_fr);\n> 'le', 'fox', 'brun', 'rapid', 't', 'saut', 'chien', 'pares'\n")),Object(o.b)("p",null,"The full code is here: ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://gist.github.com/christofur/e2ea406c21bccd3b032c9b861df0749b"}),"https://gist.github.com/christofur/e2ea406c21bccd3b032c9b861df0749b")))}u.isMDXComponent=!0}}]);