<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Chris Perks Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Chris Perks Blog Atom Feed"><title data-react-helmet="true">A workaround for missing ViewData in Sitecore MVC | Chris Perks</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="A workaround for missing ViewData in Sitecore MVC | Chris Perks"><meta data-react-helmet="true" name="description" content="Passing data between Sitecore renderings can get tricky."><meta data-react-helmet="true" property="og:description" content="Passing data between Sitecore renderings can get tricky."><meta data-react-helmet="true" property="og:url" content="https://chrisperks.github.io/workaround_missing_viewdata_sitecore_mvc"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://chrisperks.github.io/workaround_missing_viewdata_sitecore_mvc"><link rel="stylesheet" href="/styles.3751d533.css">
<link rel="preload" href="/styles.585613ed.js" as="script">
<link rel="preload" href="/runtime~main.357852cb.js" as="script">
<link rel="preload" href="/main.94ee1ea0.js" as="script">
<link rel="preload" href="/1.9cd53fbb.js" as="script">
<link rel="preload" href="/2.56f5f9a5.js" as="script">
<link rel="preload" href="/31.4319d0f1.js" as="script">
<link rel="preload" href="/935f2afb.4c0dff4f.js" as="script">
<link rel="preload" href="/17896441.11df2177.js" as="script">
<link rel="preload" href="/8356e6c9.87d079e5.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Chris Perks</strong></a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">üåú</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">üåû</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Chris Perks</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">_</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/">Home</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!"> 2021</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/sitecore_sustainability_benefits">Sustainable Sitecore - reducing CO2 emissions in your Sitecore stack</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!"> 2020</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/search_engine_not_database">When Does A Search Database Become A Search Engine?</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!"> 2019</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/custom_solr_index">Create a custom Solr index in Sitecore 9</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!"> 2018</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/xconnect_error">xConnect error when using Deploy Marketing Definitions tool</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/xconnect_local_machine">Enable xConnect on a local developer machine</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/slow_renderings">Hundreds of renderings? Your first-page-load could be sloooow</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/solr_highlights">Sitecore Search Highlighting with Solr - the highlights</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/partial_view_not_found">Sitecore 9  - The partial view was not found or no view engine supports the searched locations.</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contentsearch_quirks">Sitecore 9 - ContentSearch Solr query quirks with spaces and wildcards</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/2018_solr_error">Sitecore Solr Error - Processing Field Name. Resolving Multiple Field found on Solr Field Map. No matching template field on index field name, return type ‚ÄòString‚Äô and field type ‚Äù</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/unicorn_configs">Digging into Unicorn configs in Sitecore Habitat</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/missing_uniquekey">Sitecore Solr setup - Document is missing mandatory uniqueKey field id</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!"> 2017</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/lucene_explain">Explaining Lucene explain</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/sitecore_analyzers">Visualising Sitecore Analyzers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/elasticon">Elasticon London 2017 (for a Sitecore developer)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/patching_sitecore_commands_config">Patching the Sitecore Commands.config file</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/workaround_missing_viewdata_sitecore_mvc">A workaround for missing ViewData in Sitecore MVC</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/finding_action_name_from_mvc_processor">Finding the current Action name from an MVC pipeline processor</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/returning_json_errors_from_sitecore_mvc_controllers">Returning JSON errors from Sitecore MVC controllers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/could_not_find_process_pipeline">Error - Could not find method Process.Pipeline</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/sitecore_mvc_internals">Sitecore MVC Internals - IControllerActivator</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/sitecore_mvc_internals_factory">Sitecore MVC internals - SitecoreControllerFactory</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!"> 2016</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/async_functionality_testing_with_xunit">C# Async functionality testing with xUnit</a></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">A workaround for missing ViewData in Sitecore MVC</h1></header><div class="markdown"><p>Passing data between Sitecore renderings can get tricky.</p><p>Sending messages between sibling renderings can lead us to worry about the order in which they render, and you may end up with renderings tightly coupled to other renderings. Jeremy Davis discusses ways to switch the order of rendering execution on his blog here: <a href="https://jermdavis.wordpress.com/2016/04/04/getting-mvc-components-to-communicate/" target="_blank" rel="noopener noreferrer">https://jermdavis.wordpress.com/2016/04/04/getting-mvc-components-to-communicate/</a></p><p><img alt="img" src="/assets/images/2017_missing_viewdata_1-5f35bacb4307658f44600b58db7701b9.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="pass-data-down-not-across"></a>Pass data down, not across<a class="hash-link" href="#pass-data-down-not-across" title="Direct link to heading">#</a></h3><p>My preferred approach is for renderings to be as isolated as possible and not need to talk to siblings. In a regular MVC site, we would instantiate a <code>ViewModel</code>, and pass it down to any child (or partial) views as needed. If a child view doesn‚Äôt change this <code>ViewModel</code> at all, we don‚Äôt have to worry about order of execution or changes of state.</p><p>In Sitecore, we can achieve this by wrapping child renderings in a parent Controller Rendering. This Controller Rendering creates and prepares the <code>ViewModel</code>, and then passes it down to one or more child renderings.</p><p><img alt="img" src="/assets/images/2017_missing_viewdata_2-25225bd0ed2e5627c1161dafaaf8cabe.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="lets-recap-on-the-main-points-here"></a>Let‚Äôs recap on the main points here:<a class="hash-link" href="#lets-recap-on-the-main-points-here" title="Direct link to heading">#</a></h3><ol><li>Our parent Controller Rendering creates and prepares a <code>ViewModel</code>. This parent specifies a view, which contains one or more placeholders.</li><li>This <code>ViewModel</code> is passed along to any child renderings currently attached to the placeholders.</li><li>During execution, child renderings do not modify the <code>ViewModel</code>. We may even consider the <code>ViewModel</code> immutable while rendering takes place.</li></ol><p>Sitecore has a peculiarity here which makes our job difficult. Each rendering gets a new instance of ViewData ‚Äì explained by Kern Herskind Nightingale here: <a href="http://stackoverflow.com/a/35210022/638064" target="_blank" rel="noopener noreferrer">http://stackoverflow.com/a/35210022/638064</a>. </p><p>This puts a stop to us using <code>ViewData</code> to pass our <code>ViewModel</code> down from the parent rendering to child renderings.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the-workaround"></a>The Workaround<a class="hash-link" href="#the-workaround" title="Direct link to heading">#</a></h4><p>There‚Äôs a way you can ensure that <code>ViewData</code> is correctly passed down from parent to child renderings. Let‚Äôs go through how this is possible.</p><ol><li>In your top level controller, create a <code>ViewModel</code>, which will be passed down to all child renderings.</li></ol><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public ActionResult ParentContainer()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var viewModel = new {PageSize = 3, CurrentPage = 2, Results = Sitecore.Context.Item.Fields[&quot;Results&quot;].Value};</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return View();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><ol start="2"><li>Add it to the <code>ViewData</code> collection in the current <code>ViewContext</code></li></ol><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public ActionResult ParentContainer()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var viewModel = new {PageSize = 3, CurrentPage = 2, Results = Sitecore.Context.Item.Fields[&quot;Results&quot;].Value};</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ContextService.Get().GetCurrent().ViewData.Add(&quot;_SharedModel&quot;, viewModel);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return View();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><ol start="3"><li>In each child rendering, fetch the <code>ViewModel</code> and add it to the local <code>ViewData</code> for the current rendering (which will be empty at this point). View Renderings will do this step for you, so you don‚Äôt need to do anything special there</li></ol><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public ActionResult ChildRendering()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Get any ViewData previously added to this ViewContext</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var contextViewData = ContextService.Get().GetCurrent().ViewData;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    contextViewData.ToList().ForEach(x =&gt; ViewData.Add(x.Key, x.Value));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return View();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Et voila! You now have access to the same <code>ViewModel</code> for each of your child renderings.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Layout = null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var viewModel = ViewData[&quot;_SharedModel&quot;];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="making-it-better"></a>Making it better<a class="hash-link" href="#making-it-better" title="Direct link to heading">#</a></h4><p>MVC offers us even better tools to remove code duplication. If you have a lot of child renderings needing access to your shared <code>ViewModel</code>, adding the code in step 3 will happen a lot. Let‚Äôs refactor that to an filter attribute.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class RetrieveViewDataFilter : ActionFilterAttribute, IActionFilter</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public void OnActionExecuting(ActionExecutingContext filterContext)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        //Merge ViewData from context</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var contextViewData = ContextService.Get().GetCurrent().ViewData;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        contextViewData.ToList().ForEach(x =&gt; filterContext.Controller.ViewData.Add(x.Key, x.Value));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public void OnActionExecuted(ActionExecutedContext filterContext)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Now, we just need to add this attribute to any Action Methods who may want to access shared <code>ViewData</code> from higher up in the stack</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[RetrieveViewDataFilter]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public ActionResult ChildRendering()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return View();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>There we go. I‚Äôm sure Sitecore will amend their implementation at some point, but until then, we have an immutable, single direction <code>ViewData</code> flow.</p></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/patching_sitecore_commands_config"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">¬´ Patching the Sitecore Commands.config file</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/finding_action_name_from_mvc_processor"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Finding the current Action name from an MVC pipeline processor ¬ª</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#pass-data-down-not-across" class="table-of-contents__link">Pass data down, not across</a></li><li><a href="#lets-recap-on-the-main-points-here" class="table-of-contents__link">Let‚Äôs recap on the main points here:</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">My Links</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.linkedin.com/in/christofr/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn</a></li><li class="footer__item"><a href="https://github.com/christofur" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">¬© 2021 Chris Perks</div></div></div></footer></div>
<script src="/styles.585613ed.js"></script>
<script src="/runtime~main.357852cb.js"></script>
<script src="/main.94ee1ea0.js"></script>
<script src="/1.9cd53fbb.js"></script>
<script src="/2.56f5f9a5.js"></script>
<script src="/31.4319d0f1.js"></script>
<script src="/935f2afb.4c0dff4f.js"></script>
<script src="/17896441.11df2177.js"></script>
<script src="/8356e6c9.87d079e5.js"></script>
</body>
</html>